<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Exam Trainer — EA & CPA Australia</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--text:#e5e7eb;--muted:#9ca3af;--right:#10b981;--wrong:#ef4444;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .app{display:grid;grid-template-columns:340px 1fr;min-height:100vh}
  aside{background:var(--panel);border-right:1px solid #1f2937;padding:16px 14px;display:flex;flex-direction:column;gap:14px}
  h1{margin:0;font-size:16px} h2{margin:0;font-size:13px;color:#cbd5e1}
  .panel{background:#1f2937;border:1px solid #273244;border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .select,.input,.textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  .btn{border:1px solid #334155;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#2563eb,#22c55e);border:none}
  main{display:grid;grid-template-rows:auto 1fr}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid #1f2937;background:#111827}
  .pill{border:1px solid #374151;border-radius:999px;padding:6px 10px;font-size:12px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;padding:14px}
  .card{background:#1f2937;border:1px solid #273244;border-radius:12px;padding:12px}
  .chat{padding:10px;display:flex;flex-direction:column;gap:12px;max-height:70vh;overflow:auto}
  .bubble{background:#0b1220;border:1px solid #1f2533;border-radius:12px;padding:12px}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .opt{background:#0b1220;border:1px solid #334155;border-radius:10px;padding:10px;text-align:left;cursor:pointer}
  .opt.correct{border-color:var(--right)} .opt.wrong{border-color:var(--wrong)}
  .muted{color:var(--muted);font-size:12px}
  @media (max-width:1080px){.app{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <aside>
    <div>
      <h1>Exam Trainer</h1>
      <h2>EA + CPA Australia</h2>
    </div>
    <div class="panel">
      <div class="row" style="justify-content:space-between"><strong>Exam / Part</strong><span class="muted" id="sessionLabel">—</span></div>
      <select id="examSelect" class="select"></select>
      <div id="topics" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="startBtn">Start / Next Question</button>
        <button class="btn" id="reviewBtn">Review Mistakes</button>
        <button class="btn" id="resetBtn">Reset Progress</button>
      </div>
    </div>
    <div class="panel">
      <strong>Mock Exam</strong>
      <div class="row" style="margin-top:6px">
        <input id="mockCount" class="input" type="number" min="5" max="100" value="20" placeholder="# Questions"/>
        <input id="mockMinutes" class="input" type="number" min="5" max="240" value="60" placeholder="Minutes"/>
      </div>
      <div class="row" style="margin-top:6px">
        <label class="muted"><input id="mockHideExplain" type="checkbox" checked/> Hide explanations until end</label>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="startMockBtn">Start Mock</button>
        <button class="btn" id="endMockBtn">End Mock</button>
      </div>
    </div>
    <div class="panel">
      <strong>Question Editor</strong>
      <select id="edExam" class="select" style="margin-top:6px"></select>
      <input id="edTopic" class="input" placeholder="Topic"/>
      <textarea id="edQ" class="textarea" rows="3" placeholder="Question text"></textarea>
      <input id="edA" class="input" placeholder="Option A"/>
      <input id="edB" class="input" placeholder="Option B"/>
      <input id="edC" class="input" placeholder="Option C"/>
      <input id="edD" class="input" placeholder="Option D"/>
      <select id="edAns" class="select"><option value="0">Correct: A</option><option value="1">Correct: B</option><option value="2">Correct: C</option><option value="3">Correct: D</option></select>
      <textarea id="edExplain" class="textarea" rows="3" placeholder="Explanation"></textarea>
      <button class="btn primary" id="addQBtn" style="margin-top:6px">Add Question</button>
      <div class="muted" id="edStatus" style="margin-top:6px"></div>
    </div>
    <div class="panel">
      <strong>Progress</strong>
      <div class="row" style="justify-content:space-between;margin-top:6px"><span>Accuracy</span><span id="statAcc">—%</span></div>
      <div class="row" style="justify-content:space-between"><span>Answered</span><span id="statCount">0</span></div>
    </div>
  </aside>
  <main>
    <header>
      <div>Chat Q&A</div>
      <div class="pill" id="modePill">Practice Mode</div>
    </header>
    <div class="grid">
      <section class="card">
        <div id="chat" class="chat" aria-live="polite"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="skipBtn">Skip</button>
          <div style="flex:1"></div>
          <button class="btn primary" id="nextBtn">Next</button>
        </div>
      </section>
      <section class="card">
        <strong>Question Info</strong>
        <div id="qInfo" class="muted" style="margin-top:6px">No question loaded.</div>
        <hr style="border-color:#273244;margin:10px 0"/>
        <strong>Notes</strong>
        <div id="notes" class="muted" style="margin-top:6px">Pick an exam and click Start.</div>
        <hr style="border-color:#273244;margin:10px 0"/>
        <strong>Mock Status</strong>
        <div id="mockStatus" class="muted" style="margin-top:6px">—</div>
      </section>
    </div>
  </main>
</div>

<script>
/* ---------- Default Question Bank (4 parts) ---------- */
const DEFAULT_BANK={
 "EA-P1":{name:"EA Part 1 — Individuals",topics:["Filing Status","Income & Assets","Credits"],questions:[
   {id:"P1-1",topic:"Filing Status",q:"Unmarried on 12/31, supports a qualifying child all year. Best status?",options:["Single","Head of Household","MFS","QSS"],answer:1,explain:"HoH if unmarried, pay >50% household costs, qualifying person >6 months."},
   {id:"P1-2",topic:"Income & Assets",q:"Which is taxed at preferential rates?",options:["Short-term gains","Long-term gains","Wages","Interest"],answer:1,explain:"Long-term capital gains (held >1 year) use 0/15/20% brackets."},
   {id:"P1-3",topic:"Credits",q:"Child Tax Credit fact:",options:["Adjustment to income","Always refundable","Part may be refundable","Only with no earned income"],answer:2,explain:"Additional CTC may be refundable; main CTC is nonrefundable."}
 ]},
 "EA-P2":{name:"EA Part 2 — Businesses",topics:["Entity Types","Depreciation","Employment Taxes"],questions:[
   {id:"P2-1",topic:"Entity Types",q:"S corp income is taxed:",options:["Only corporate","Only shareholder","Both","Tax-exempt"],answer:1,explain:"S corps are pass-through; tax at shareholder level via K-1."},
   {id:"P2-2",topic:"Depreciation",q:"§179 vs bonus:",options:["§179 only real property","Both can create losses but §179 limited by TI","Bonus is new assets only","§179 unlimited"],answer:1,explain:"§179 has dollar & taxable-income limits; bonus generally not."},
   {id:"P2-3",topic:"Employment Taxes",q:"Employers must withhold:",options:["Nothing","Only FUTA","Only state UE","FICA + income tax"],answer:3,explain:"Withhold FIT + FICA; deposit and pay employer portions."}
 ]},
 "EA-P3":{name:"EA Part 3 — Rep & Procedures",topics:["Circular 230","Appeals","Collections"],questions:[
   {id:"P3-1",topic:"Circular 230",q:"Due diligence duty:",options:["Blindly rely on client","Reasonable inquiries if info seems wrong","Audit client","Ignore prior positions"],answer:1,explain:"Make reasonable inquiries when info appears incorrect/incomplete."},
   {id:"P3-2",topic:"Appeals",q:"Independent review office:",options:["Collections","Chief Counsel","Appeals Office","Advocate"],answer:2,explain:"Independent Office of Appeals resolves disputes impartially."},
   {id:"P3-3",topic:"Collections",q:"Settle for less than full:",options:["IA","CNC","OIC","Penalty abatement"],answer:2,explain:"Offer in Compromise may settle for less than full tax due."}
 ]},
 "CPA-EG":{name:"CPA Australia — Ethics & Governance",topics:["APES 110","Independence","Governance"],questions:[
   {id:"EG-1",topic:"APES 110",q:"NOT a fundamental principle:",options:["Integrity","Objectivity","Confidentiality","Professional Advertising"],answer:3,explain:"Principles: Integrity, Objectivity, Competence & Due Care, Confidentiality, Professional Behavior."},
   {id:"EG-2",topic:"Independence",q:"Audit partner holds client shares via family trust → threat:",options:["Self-interest","Advocacy","Familiarity","Intimidation"],answer:0,explain:"Financial interest creates self-interest threat; remove or dispose."},
   {id:"EG-3",topic:"Governance",q:"Committee for financial reporting & external audit:",options:["Nomination","Audit","Remuneration","Risk"],answer:1,explain:"Audit Committee oversees reporting, controls, and external audit."}
 ]}
};
/* ---------- State / Storage ---------- */
const STORAGE_KEY='examTrainerProgress_v1';
let BANK=JSON.parse(JSON.stringify(DEFAULT_BANK));
let PROG=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
for(const k of Object.keys(BANK)) if(!PROG[k]) PROG[k]={answered:0,correct:0,byTopic:{},mistakes:[]};
let STATE={exam:"EA-P1",topicFilters:new Set(),reviewMode:false,lastQuestion:null,mock:{active:false,queue:[],index:0,remainingMs:0,timer:null,results:[]}};
/* ---------- DOM Helpers ---------- */
const $=s=>document.querySelector(s);
const chatEl=$("#chat"), examSelectEl=$("#examSelect"), topicsEl=$("#topics");
/* ---------- Render ---------- */
function renderExamSelect(){
  examSelectEl.innerHTML=Object.entries(BANK).map(([id,v])=>`<option value="${id}">${v.name}</option>`).join('');
  examSelectEl.value=STATE.exam;
  $("#edExam").innerHTML=examSelectEl.innerHTML; $("#edExam").value=STATE.exam;
  $("#sessionLabel").textContent=BANK[STATE.exam].name;
}
function renderTopics(){
  const t=BANK[STATE.exam].topics;
  topicsEl.innerHTML=t.map(x=>`<label class="muted"><input type="checkbox" data-topic="${x}"> ${x}</label>`).join('');
}
function renderStats(){
  const p=PROG[STATE.exam]; const acc=p.answered? (p.correct/p.answered):0;
  $("#statAcc").textContent=(Math.round(acc*1000)/10).toFixed(1)+"%";
  $("#statCount").textContent=p.answered;
}
/* ---------- Chat Helpers ---------- */
function bubble(html){const d=document.createElement('div');d.className='bubble';d.innerHTML=html;chatEl.appendChild(d);chatEl.scrollTop=chatEl.scrollHeight;}
/* ---------- Pool / Pick / Ask ---------- */
function currentPool(){
  let pool=BANK[STATE.exam].questions.slice();
  if(STATE.topicFilters.size){pool=pool.filter(q=>STATE.topicFilters.has(q.topic));}
  if(STATE.reviewMode){const ids=new Set(PROG[STATE.exam].mistakes); pool=pool.filter(q=>ids.has(q.id));}
  return pool;
}
function pickQuestion(){
  const pool=currentPool(); if(!pool.length) return null;
  let q=null; let tries=0; const last=STATE.lastQuestion?.id;
  do{ q=pool[Math.floor(Math.random()*pool.length)]; tries++; }while(q && q.id===last && tries<5);
  return q;
}
function ask(q){
  STATE.lastQuestion=q;
  $("#qInfo").textContent=`${q.id} — ${q.topic}`;
  const opts=q.options.map((opt,i)=>`<button class="opt" data-idx="${i}"><b>${String.fromCharCode(65+i)}.</b> ${opt}</button>`).join('');
  bubble(`<div><b>${BANK[STATE.exam].name}</b> • <i>${q.topic}</i></div><div style="margin-top:6px">${q.q}</div><div class="options" style="margin-top:8px">${opts}</div>`);
}
/* ---------- Grade ---------- */
function grade(q,choice){
  const correct=(choice===q.answer);
  const p=PROG[STATE.exam]; p.answered++; if(!p.byTopic[q.topic]) p.byTopic[q.topic]={a:0,c:0}; p.byTopic[q.topic].a++; if(correct){p.correct++; p.byTopic[q.topic].c++;} else { if(!p.mistakes.includes(q.id)) p.mistakes.push(q.id); }
  localStorage.setItem(STORAGE_KEY,JSON.stringify(PROG)); renderStats();
  const last=chatEl.querySelectorAll('.options'); const opts=last[last.length-1]?.querySelectorAll('.opt')||[];
  opts.forEach((btn,i)=>{btn.disabled=true; if(i===q.answer)btn.classList.add('correct'); if(i===choice && i!==q.answer)btn.classList.add('wrong');});
  bubble((correct?`<span style="color:var(--right)"><b>Correct.</b></span>`:`<span style="color:var(--wrong)"><b>Incorrect.</b></span>`) + ` <div class="muted" style="margin-top:6px">${q.explain}</div>`);
  if(STATE.mock.active){ STATE.mock.results.push({id:q.id,topic:q.topic,correct}); updateMockStatus(); if(STATE.mock.index>=STATE.mock.queue.length){ endMock(); } }
}
/* ---------- Mock Exam ---------- */
function fmt(ms){const s=Math.max(0,Math.floor(ms/1000));const m=Math.floor(s/60);const r=s%60;return `${m}:${String(r).padStart(2,'0')}`;}
function startMock(){
  const n=+$("#mockCount").value||20, mins=+$("#mockMinutes").value||60;
  const pool=currentPool(); if(!pool.length){bubble("<i>No questions for selected filters.</i>");return;}
  STATE.mock={active:true,queue:pool.sort(()=>Math.random()-0.5).slice(0,n),index:0,remainingMs:mins*60*1000,timer:null,results:[]};
  $("#modePill").textContent="Mock Exam"; $("#notes").textContent="Mock started. Explanations appear after each answer when not hidden at end.";
  $("#mockStatus").textContent=`Progress: 0/${STATE.mock.queue.length} • Time Left: ${fmt(STATE.mock.remainingMs)}`;
  STATE.mock.timer=setInterval(()=>{STATE.mock.remainingMs-=1000; updateMockStatus(); if(STATE.mock.remainingMs<=0){ endMock(); }},1000);
  chatEl.innerHTML=""; ask(STATE.mock.queue[STATE.mock.index++]);
}
function updateMockStatus(){ if(!STATE.mock.active) return; $("#mockStatus").textContent=`Progress: ${STATE.mock.results.length}/${STATE.mock.queue.length} • Time Left: ${fmt(STATE.mock.remainingMs)}`;}
function endMock(){
  if(!STATE.mock.active) return; clearInterval(STATE.mock.timer);
  const total=STATE.mock.queue.length; const correct=STATE.mock.results.filter(r=>r.correct).length; const score=total?Math.round(correct/total*100):0;
  bubble(`<b>Mock finished.</b> Score: <b>${score}%</b> (${correct}/${total})`);
  STATE.mock.active=false; $("#modePill").textContent="Practice Mode"; $("#mockStatus").textContent="—";
}
/* ---------- Editor ---------- */
function addQuestion(){
  const ex=$("#edExam").value, topic=($("#edTopic").value||'General').trim(), q=($("#edQ").value||'').trim();
  const A=$("#edA").value.trim(), B=$("#edB").value.trim(), C=$("#edC").value.trim(), D=$("#edD").value.trim();
  const ans=+$("#edAns").value, explain=$("#edExplain").value.trim();
  if(!q||!A||!B||!C||!D||explain===''){ $("#edStatus").textContent="Fill all fields."; return; }
  const id=`${ex}-${Date.now().toString(36)}`;
  if(!BANK[ex].topics.includes(topic)) BANK[ex].topics.push(topic);
  BANK[ex].questions.push({id,topic,q,options:[A,B,C,D],answer:ans,explain});
  $("#edStatus").textContent="Question added."; renderTopics();
  $("#edQ").value=$("#edA").value=$("#edB").value=$("#edC").value=$("#edD").value=$("#edExplain").value="";
}
/* ---------- Events ---------- */
examSelectEl.addEventListener('change',e=>{STATE.exam=e.target.value;STATE.topicFilters=new Set();STATE.reviewMode=false;$("#sessionLabel").textContent=BANK[STATE.exam].name;renderTopics();renderStats();});
topicsEl.addEventListener('change',e=>{if(e.target.matches('input[data-topic]')){const t=e.target.getAttribute('data-topic');e.target.checked?STATE.topicFilters.add(t):STATE.topicFilters.delete(t);}});
$("#startBtn").addEventListener('click',()=>{if(STATE.mock.active){bubble("<i>Mock running. End it first.</i>");return;}const q=pickQuestion(); if(!q){bubble("<i>No questions available.</i>");return;} ask(q);});
$("#nextBtn").addEventListener('click',()=>{if(STATE.mock.active){ if(STATE.mock.index<STATE.mock.queue.length){ ask(STATE.mock.queue[STATE.mock.index++]); updateMockStatus(); } else { endMock(); } return;} const q=pickQuestion(); if(q) ask(q);});
$("#skipBtn").addEventListener('click',()=>{$("#nextBtn").click();});
$("#reviewBtn").addEventListener('click',()=>{if(STATE.mock.active){bubble("<i>Cannot switch during mock.</i>");return;} STATE.reviewMode=!STATE.reviewMode; $("#modePill").textContent=STATE.reviewMode?"Review Mistakes":"Practice Mode";});
$("#resetBtn").addEventListener('click',()=>{if(confirm('Reset progress for this exam?')){PROG[STATE.exam]={answered:0,correct:0,byTopic:{},mistakes:[]}; localStorage.setItem(STORAGE_KEY,JSON.stringify(PROG)); renderStats(); bubble("<b>Progress reset.</b>");}});
$("#startMockBtn").addEventListener('click',startMock);
$("#endMockBtn").addEventListener('click',endMock);
$("#addQBtn").addEventListener('click',addQuestion);
chatEl.addEventListener('click',e=>{
  const btn=e.target.closest('.opt'); if(!btn) return; const idx=+btn.getAttribute('data-idx'); const q=STATE.lastQuestion; if(!q) return;
  grade(q,idx);
});
/* ---------- Init ---------- */
function init(){ renderExamSelect(); renderTopics(); renderStats(); chatEl.innerHTML=""; bubble("<b>Welcome!</b> Choose an exam/part, optionally tick topics, then click <b>Start / Next Question</b>."); }
init();
</script>
</body>
</html>
