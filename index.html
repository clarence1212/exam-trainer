<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Exam Trainer — EA & CPA Australia (Single & Multi-Select)</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --card:#1f2937;
    --text:#e5e7eb; --muted:#9ca3af; --right:#10b981; --wrong:#ef4444;
    --chip:#374151; --border:#273244; --ink:#0b1220;
    --accent:#2563eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .app{display:grid;grid-template-columns:340px 1fr;min-height:100vh}
  aside{background:var(--panel);border-right:1px solid #1f2937;padding:16px 14px;display:flex;flex-direction:column;gap:14px}
  h1{margin:0;font-size:16px} h2{margin:0;font-size:13px;color:#cbd5e1}
  .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .select,.input,.textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:var(--ink);color:var(--text)}
  .btn{border:1px solid #334155;background:var(--ink);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#2563eb,#22c55e);border:none}
  .btn.ghost{background:transparent}
  .btn.warn{background:#361416;border:1px solid #7f1d1d}
  .chip{background:var(--chip);border:1px solid #475569;border-radius:999px;padding:6px 10px;font-size:12px;display:flex;align-items:center;gap:6px}
  .muted{color:var(--muted);font-size:12px}
  main{display:grid;grid-template-rows:auto 1fr}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid #1f2937;background:var(--panel)}
  .pill{border:1px solid #374151;border-radius:999px;padding:6px 10px;font-size:12px}
  .grid-two{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;padding:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .chat{padding:10px;display:flex;flex-direction:column;gap:12px;max-height:70vh;overflow:auto}
  .msg{max-width:980px}
  .bubble{background:var(--ink);border:1px solid #1f2533;border-radius:12px;padding:12px;line-height:1.45}
  .bubble.me{background:#0a0f1a}
  .qmeta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .tag{font-size:11px;color:#cbd5e1;background:var(--ink);border:1px solid #334155;border-radius:999px;padding:4px 8px}
  .scenario{background:#0c1424;border:1px dashed #2b3850;border-radius:10px;padding:10px;margin:8px 0;color:#d1d5db}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .opt{background:var(--ink);border:1px solid #334155;border-radius:10px;padding:10px;text-align:left;cursor:pointer;color:var(--text)} /* FIXED */
  .opt.correct{border-color:var(--right)} .opt.wrong{border-color:var(--wrong)}
  .explain{border-left:3px solid #3b82f6;padding-left:10px;margin-top:10px;color:#cbd5e1}
  .composer{display:flex;gap:8px;padding:12px;border-top:1px solid #1f2937;background:var(--panel)}
  .grid-two .card hr{border-color:var(--border)}
  .small{font-size:12px}
  .row-split{display:flex;gap:8px}.row-split>*{flex:1}
  .hidden{display:none}

  /* Multi-select layout uses checkboxes */
  .multi .options{grid-template-columns:1fr}
  .choice{display:flex;gap:10px;align-items:flex-start;border:1px solid #334155;border-radius:10px;background:var(--ink);padding:10px}
  .choice input{margin-top:3px;accent-color:var(--accent)}
  .choice.correct{border-color:var(--right)} .choice.wrong{border-color:var(--wrong)}
  @media (max-width:1080px){.app{grid-template-columns:1fr}.grid-two{grid-template-columns:1fr}.options{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside>
    <div><h1>Exam Trainer</h1><h2>EA + CPA Australia</h2></div>

    <!-- Exam / Topics -->
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <strong>Exam / Part</strong><span id="sessionLabel" class="muted">—</span>
      </div>
      <select id="examSelect" class="select"></select>
      <div id="topics" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="startBtn">Start / Next Question</button>
        <button class="btn" id="reviewBtn">Review Mistakes</button>
        <button class="btn warn" id="resetBtn">Reset Progress</button>
      </div>
    </div>

    <!-- Mock -->
    <div class="panel">
      <strong>Mock Exam</strong>
      <div class="row" style="margin-top:6px">
        <input id="mockCount" class="input" type="number" min="5" max="100" value="20" placeholder="# Questions"/>
        <input id="mockMinutes" class="input" type="number" min="5" max="240" value="60" placeholder="Minutes"/>
      </div>
      <div class="row" style="margin-top:6px">
        <label class="muted"><input id="mockHideExplain" type="checkbox" checked/> Hide explanations until end</label>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="startMockBtn">Start Mock</button>
        <button class="btn" id="endMockBtn">End Mock</button>
      </div>
    </div>

    <!-- Performance -->
    <div class="panel">
      <strong>Performance</strong>
      <div class="row" style="justify-content:space-between;margin-top:6px"><span>Accuracy</span><span id="statAcc">—%</span></div>
      <div class="row" style="justify-content:space-between"><span>Answered</span><span id="statCount">0</span></div>
    </div>

    <!-- Editor (supports multi-select) -->
    <div class="panel">
      <strong>Question Editor</strong> <span class="muted small">(saved to your browser)</span>
      <select id="edExam" class="select" style="margin-top:6px"></select>
      <input id="edTopic" class="input" placeholder="Topic"/>
      <textarea id="edScenario" class="textarea" rows="3" placeholder="(Optional) Scenario / Case stem"></textarea>
      <textarea id="edQ" class="textarea" rows="2" placeholder="Question (what is being asked?)"></textarea>

      <div class="row" style="margin-top:6px">
        <label class="chip"><input type="checkbox" id="edIsMulti"> Multi-select (select all that apply)</label>
      </div>

      <div class="row-split">
        <input id="edA" class="input" placeholder="Option A"/>
        <label class="chip"><input type="checkbox" id="edAc"> Correct</label>
      </div>
      <div class="row-split">
        <input id="edB" class="input" placeholder="Option B"/>
        <label class="chip"><input type="checkbox" id="edBc"> Correct</label>
      </div>
      <div class="row-split">
        <input id="edC" class="input" placeholder="Option C"/>
        <label class="chip"><input type="checkbox" id="edCc"> Correct</label>
      </div>
      <div class="row-split">
        <input id="edD" class="input" placeholder="Option D"/>
        <label class="chip"><input type="checkbox" id="edDc"> Correct</label>
      </div>

      <textarea id="edExplain" class="textarea" rows="3" placeholder="Explanation"></textarea>
      <button class="btn primary" id="addQBtn" style="margin-top:6px">Add Question</button>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="exportBankBtn">Export Bank</button>
        <input type="file" id="importBankFile" class="hidden" accept="application/json"/>
        <button class="btn" id="importBankBtn">Import Bank</button>
      </div>
      <div id="edStatus" class="muted" style="margin-top:6px"></div>
    </div>

    <!-- AI Generator -->
    <div class="panel">
      <strong>AI Question Generator</strong>
      <input id="genBase" class="input" value="https://api.openai.com/v1" placeholder="Base URL (OpenAI API)"/>
      <div class="row-split" style="margin-top:6px">
        <input id="genModel" class="input" value="gpt-4o-mini" placeholder="Model"/>
        <input id="genKey" class="input" placeholder="API Key (sk-…)"/>
      </div>
      <div class="row-split" style="margin-top:6px">
        <select id="genExam" class="select"></select>
        <input id="genTopic" class="input" placeholder="Topic (e.g., Circular 230)"/>
      </div>
      <div class="row-split" style="margin-top:6px">
        <select id="genDiff" class="select"><option>easy</option><option selected>medium</option><option>hard</option></select>
        <input id="genCount" class="input" type="number" min="1" max="20" value="5"/>
      </div>
      <button class="btn primary" id="genBtn" style="margin-top:6px">Generate & Add</button>
      <div id="genStatus" class="muted" style="margin-top:6px">Adds single-answer MCQs to the selected exam/topic.</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main>
    <header>
      <div>Chat Q&A</div>
      <div class="pill" id="modePill">Practice Mode</div>
    </header>

    <div class="grid-two">
      <section class="card">
        <div id="chat" class="chat" aria-live="polite"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="skipBtn">Skip</button>
          <div style="flex:1"></div>
          <button class="btn primary" id="nextBtn">Next</button>
        </div>
      </section>
      <section class="card">
        <strong>Question Info</strong>
        <div id="qInfo" class="muted small" style="margin-top:6px">No question loaded.</div>
        <hr/>
        <strong>Notes</strong>
        <div id="notes" class="muted small" style="margin-top:6px">Choose an exam, optionally tick topics, then Start.</div>
        <hr/>
        <strong>Mock Status</strong>
        <div id="mockStatus" class="muted small" style="margin-top:6px">—</div>
      </section>
    </div>
  </main>
</div>

<script>
/* ---------------- Default Bank with single & multi examples ---------------- */
const DEFAULT_BANK={
 "EA-P1":{name:"EA Part 1 — Individuals",topics:["Filing Status","Income & Assets","Credits","Social Security"],questions:[
   {id:"P1-1",type:"single",topic:"Filing Status",q:"Best filing status?",scenario:"Taxpayer is unmarried on 12/31 and supported a qualifying child who lived with them all year.",options:["Single","Head of Household","Married Filing Separately","Qualifying Surviving Spouse"],answer:1,explain:"HoH if unmarried, pays >50% household costs, qualifying person >6 months."},
   {id:"P1-2",type:"single",topic:"Income & Assets",q:"Preferential rate item?",options:["Short-term cap gains","Long-term cap gains","Wages","Interest"],answer:1,explain:"LTCG (held >1 year) get 0/15/20% rates."},
   {id:"P1-3",type:"multi",topic:"Social Security",scenario:"Taxpayer receives Social Security benefits.",q:"Which statements are true? Select all that apply.",options:[
     "Up to 85% of benefits may be taxable depending on provisional income.",
     "Benefits are always 100% tax-free.",
     "Provisional income includes AGI, nontaxable interest, and half of benefits.",
     "Taxability uses the same thresholds for MFJ and Single."
   ],answers:[0,2],explain:"Up to 85% may be taxable; provisional income = AGI + tax-exempt interest + 1/2 benefits. Thresholds differ by status."
   }
 ]},
 "EA-P2":{name:"EA Part 2 — Businesses",topics:["Entity Types","Depreciation","Employment Taxes","QBI"],questions:[
   {id:"P2-1",type:"single",topic:"Entity Types",q:"S-corp income is taxed where?",options:["Corporate only","Shareholder only","Both","Neither"],answer:1,explain:"Pass-through to shareholders via K-1."},
   {id:"P2-2",type:"multi",topic:"Depreciation",q:"§179 vs bonus: select all true.",options:[
     "§179 has taxable-income and dollar limits.",
     "Bonus depreciation cannot create or increase a loss.",
     "Both apply to certain tangible personal property.",
     "§179 can be limited by business income."
   ],answers:[0,2,3],explain:"§179 has limits; bonus generally not limited by TI; both apply to qualifying property."
   }
 ]},
 "EA-P3":{name:"EA Part 3 — Representation & Procedures",topics:["Circular 230","Appeals","Collections"],questions:[
   {id:"P3-1",type:"single",topic:"Circular 230",q:"Due diligence requires:",options:[
     "Blind reliance on client info","Reasonable inquiries when info seems wrong","Auditing the client","Ignoring prior-year positions"
   ],answer:1,explain:"Make reasonable inquiries where info appears incorrect/incomplete."}
 ]},
 "CPA-EG":{name:"CPA Australia — Ethics & Governance",topics:["APES 110","Independence","Governance","NOCLAR"],questions:[
   {id:"EG-1",type:"single",topic:"APES 110",q:"NOT a fundamental principle:",options:["Integrity","Objectivity","Confidentiality","Professional Advertising"],answer:3,explain:"Principles: Integrity, Objectivity, Competence & Due Care, Confidentiality, Professional Behavior."},
   {id:"EG-2",type:"multi",topic:"Independence",scenario:"You are the audit partner. Your spouse holds shares in the audit client via a family trust.",q:"What threats arise? Select all that apply.",options:[
     "Self-interest threat","Advocacy threat","Familiarity threat","Intimidation threat"
   ],answers:[0,2],explain:"Financial interest → self-interest; close relationships can create familiarity threat."
   }
 ]}
};

/* ---------------- Merge with user bank stored locally ---------------- */
const BANK_STORAGE_KEY='examTrainerBank_v2_multi';
function loadUserBank(){ try{return JSON.parse(localStorage.getItem(BANK_STORAGE_KEY)||'{}')}catch(e){return{}} }
function saveUserBank(obj){ localStorage.setItem(BANK_STORAGE_KEY, JSON.stringify(obj)); }
let USER_BANK=loadUserBank();

function clone(o){return JSON.parse(JSON.stringify(o))}
function mergeBanks(){
  const merged=clone(DEFAULT_BANK);
  for(const [exam,data] of Object.entries(USER_BANK)){
    if(!merged[exam]) merged[exam]={name:data.name||exam,topics:[],questions:[]};
    const tset=new Set(merged[exam].topics);
    (data.topics||[]).forEach(t=>tset.add(t));
    merged[exam].topics=[...tset];
    (data.questions||[]).forEach(q=>merged[exam].questions.push(q));
  }
  return merged;
}
let BANK=mergeBanks();

/* ---------------- Progress storage ---------------- */
const STORAGE_KEY='examTrainerProgress_v2_multi';
let PROG=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
for(const k of Object.keys(BANK)) if(!PROG[k]) PROG[k]={answered:0,correct:0,byTopic:{},mistakes:[]};
function saveProg(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(PROG)); }

/* ---------------- State ---------------- */
let STATE={exam:"EA-P1",topicFilters:new Set(),reviewMode:false,lastQuestion:null,mock:{active:false,queue:[],index:0,remainingMs:0,timer:null,results:[]}};
const $=s=>document.querySelector(s);
const chatEl=$("#chat");

/* ---------------- Render helpers ---------------- */
function renderExamSelect(){
  const html=Object.entries(BANK).map(([id,v])=>`<option value="${id}">${v.name}</option>`).join('');
  $("#examSelect").innerHTML=html; $("#examSelect").value=STATE.exam;
  $("#edExam").innerHTML=html; $("#edExam").value=STATE.exam;
  $("#genExam").innerHTML=html; $("#genExam").value=STATE.exam;
  $("#sessionLabel").textContent=BANK[STATE.exam].name;
}
function renderTopics(){
  const ts=BANK[STATE.exam].topics||[];
  $("#topics").innerHTML=ts.map(t=>`<label class="chip"><input type="checkbox" data-topic="${t}"> ${t}</label>`).join('');
}
function renderStats(){
  const p=PROG[STATE.exam]; const acc=p.answered? (p.correct/p.answered):0;
  $("#statAcc").textContent=(Math.round(acc*1000)/10).toFixed(1)+"%";
  $("#statCount").textContent=p.answered;
}
function bubble(html,me=false){const d=document.createElement('div');d.className='msg';d.innerHTML=`<div class="bubble${me?' me':''}">${html}</div>`;chatEl.appendChild(d);chatEl.scrollTop=chatEl.scrollHeight;}

/* ---------------- Pool / Pick / Render ---------------- */
function currentPool(){
  let pool=(BANK[STATE.exam].questions||[]).slice();
  if(STATE.topicFilters.size) pool=pool.filter(q=>STATE.topicFilters.has(q.topic));
  if(STATE.reviewMode){ const ids=new Set(PROG[STATE.exam].mistakes); pool=pool.filter(q=>ids.has(q.id)); }
  return pool;
}
function pickQuestion(){
  const pool=currentPool(); if(!pool.length) return null;
  let q=null, tries=0, last=STATE.lastQuestion?.id;
  do{ q=pool[Math.floor(Math.random()*pool.length)]; tries++; }while(q && q.id===last && tries<5);
  return q;
}
function renderQuestion(q){
  STATE.lastQuestion=q;
  $("#qInfo").textContent=`${q.id} — ${q.topic} • ${q.type==='multi'?'Multi-select':'Single'}`;
  const meta=`<div class="qmeta"><span class="tag">${BANK[STATE.exam].name}</span><span class="tag">${q.topic}</span>${q.type==='multi'?'<span class="tag">Multi-select</span>':''}</div>`;
  const scenario = q.scenario ? `<div class="scenario">${q.scenario}</div>` : '';
  let body = `${meta}${scenario}<div style="font-weight:700;margin-top:4px">${q.q}</div>`;
  if(q.type==='multi'){
    const items=q.options.map((t,i)=>`
      <label class="choice" data-idx="${i}">
        <input type="checkbox" />
        <div><b>${String.fromCharCode(65+i)}.</b> ${t}</div>
      </label>`).join('');
    body += `<div class="options">${items}</div>
             <div class="row" style="margin-top:8px"><button class="btn primary" id="submitMulti">Submit</button></div>`;
  }else{
    const items=q.options.map((t,i)=>`<button class="opt" data-idx="${i}"><b>${String.fromCharCode(65+i)}.</b> ${t}</button>`).join('');
    body += `<div class="options">${items}</div>`;
  }
  bubble(body);
}

/* ---------------- Grading ---------------- */
function markProgress(q, correct){
  const p=PROG[STATE.exam]; p.answered++; if(!p.byTopic[q.topic]) p.byTopic[q.topic]={a:0,c:0};
  p.byTopic[q.topic].a++; if(correct){p.correct++; p.byTopic[q.topic].c++;} else { if(!p.mistakes.includes(q.id)) p.mistakes.push(q.id); }
  saveProg(); renderStats();
}
function gradeSingle(q, choice){
  const correct=(choice===q.answer);
  // colorize
  const opts=chatEl.querySelectorAll('.options:last-of-type .opt');
  opts.forEach((btn,i)=>{btn.disabled=true; if(i===q.answer)btn.classList.add('correct'); if(i===choice && i!==q.answer)btn.classList.add('wrong');});
  markProgress(q,correct);
  bubble((correct?`<span style="color:var(--right)"><b>Correct.</b></span>`:`<span style="color:var(--wrong)"><b>Incorrect.</b></span>`) + ` <div class="explain">${q.explain}</div>`);
}
function gradeMulti(q){
  const chosen=[...chatEl.querySelectorAll('.options:last-of-type .choice input:checked')].map(el=>Number(el.closest('.choice').dataset.idx));
  const correctSet=new Set(q.answers||[]);
  const chosenSet=new Set(chosen);
  // correctness = same members
  let ok = (chosenSet.size===correctSet.size) && [...correctSet].every(x=>chosenSet.has(x));
  // colorize
  const wrappers=chatEl.querySelectorAll('.options:last-of-type .choice');
  wrappers.forEach((w,i)=>{
    w.classList.add(correctSet.has(i)?'correct':(chosenSet.has(i)?'wrong':''));
    w.querySelector('input').disabled=true;
  });
  markProgress(q,ok);
  bubble((ok?`<span style="color:var(--right)"><b>Correct.</b></span>`:`<span style="color:var(--wrong)"><b>Incorrect.</b></span>`) + ` <div class="explain">${q.explain}</div>`);
}

/* ---------------- Mock Exam ---------------- */
function fmt(ms){const s=Math.max(0,Math.floor(ms/1000));const m=Math.floor(s/60);const r=s%60;return `${m}:${String(r).padStart(2,'0')}`;}
function startMock(){
  const n=+$("#mockCount").value||20, mins=+$("#mockMinutes").value||60;
  const pool=currentPool(); if(!pool.length){bubble("<i>No questions for selected filters.</i>");return;}
  STATE.mock={active:true,queue:pool.sort(()=>Math.random()-0.5).slice(0,n),index:0,remainingMs:mins*60*1000,timer:setInterval(()=>{STATE.mock.remainingMs-=1000;updateMockStatus();if(STATE.mock.remainingMs<=0)endMock();},1000),results:[]};
  $("#modePill").textContent="Mock Exam"; $("#mockStatus").textContent=`Progress: 0/${n} • Time Left: ${fmt(STATE.mock.remainingMs)}`;
  chatEl.innerHTML=""; renderQuestion(STATE.mock.queue[STATE.mock.index++]);
}
function updateMockStatus(){ if(!STATE.mock.active) return; $("#mockStatus").textContent=`Progress: ${STATE.mock.results.length}/${STATE.mock.queue.length} • Time Left: ${fmt(STATE.mock.remainingMs)}`;}
function endMock(){
  if(!STATE.mock.active) return; clearInterval(STATE.mock.timer);
  const total=STATE.mock.queue.length; const correct=STATE.mock.results.filter(r=>r.correct).length; const score=total?Math.round(correct/total*100):0;
  bubble(`<b>Mock finished.</b> Score: <b>${score}%</b> (${correct}/${total})`);
  STATE.mock.active=false; $("#modePill").textContent="Practice Mode"; $("#mockStatus").textContent="—";
}

/* ---------------- Editor: add single or multi ---------------- */
function edStatus(t){ const el=$("#edStatus"); el.textContent=t; setTimeout(()=>el.textContent="",3000); }
function addQuestion(){
  const ex=$("#edExam").value, topic=($("#edTopic").value||'General').trim();
  const scenario=$("#edScenario").value.trim(), q=($("#edQ").value||'').trim();
  const A=$("#edA").value.trim(), B=$("#edB").value.trim(), C=$("#edC").value.trim(), D=$("#edD").value.trim();
  const isMulti=$("#edIsMulti").checked;
  const explain=$("#edExplain").value.trim();
  if(!q||!A||!B||!C||!D||!explain){ edStatus("Please fill all fields (scenario optional)."); return; }

  const id=`${ex}-${Date.now().toString(36)}`;
  if(!USER_BANK[ex]) USER_BANK[ex]={name:BANK[ex]?.name||ex,topics:[],questions:[]};
  const tset=new Set(USER_BANK[ex].topics||[]); tset.add(topic); USER_BANK[ex].topics=[...tset];

  let item;
  if(isMulti){
    const ans=[];
    if($("#edAc").checked) ans.push(0);
    if($("#edBc").checked) ans.push(1);
    if($("#edCc").checked) ans.push(2);
    if($("#edDc").checked) ans.push(3);
    if(ans.length===0){ edStatus("Select at least one correct option for multi-select."); return; }
    item={id,type:"multi",topic,scenario,q,options:[A,B,C,D],answers:ans,explain};
  }else{
    // single: pick the first checked as answer; default A if none checked
    let ans = $("#edAc").checked?0: $("#edBc").checked?1: $("#edCc").checked?2: $("#edDc").checked?3:0;
    item={id,type:"single",topic,scenario,q,options:[A,B,C,D],answer:ans,explain};
  }

  USER_BANK[ex].questions.push(item);
  saveUserBank(USER_BANK); BANK=mergeBanks(); renderExamSelect(); renderTopics();
  $("#edQ").value=$("#edScenario").value=$("#edA").value=$("#edB").value=$("#edC").value=$("#edD").value=$("#edExplain").value="";
  $("#edAc").checked=$("#edBc").checked=$("#edCc").checked=$("#edDc").checked=false; $("#edIsMulti").checked=false;
  edStatus("Question added.");
}

/* ---------------- AI generator (single-answer MCQs) ---------------- */
function buildPrompt(examName, topic, count, diff){
  return `You are an expert exam item writer for ${examName}.
Generate ${count} SINGLE-ANSWER multiple-choice questions (A–D) for topic: ${topic}. Difficulty: ${diff}.
Return STRICT JSON ONLY: an array of {question, options[4], answerIndex, explanation}. No extra text.`;
}
async function callOpenAI(base, model, key, examName, topic, count, diff){
  const resp = await fetch(base+'/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
    body: JSON.stringify({
      model, temperature:0.2,
      messages:[
        {role:'system',content:'Output strict JSON only.'},
        {role:'user',content:buildPrompt(examName,topic,count,diff)}
      ]
    })
  });
  if(!resp.ok) throw new Error('HTTP '+resp.status);
  const data=await resp.json();
  const text=data?.choices?.[0]?.message?.content?.trim()||'[]';
  const m=text.match(/```(?:json)?\n([\s\S]*?)\n```/i); const json=m?m[1]:text;
  return JSON.parse(json);
}
async function generateAndAdd(){
  const base=$("#genBase").value.trim(), model=$("#genModel").value.trim(), key=$("#genKey").value.trim();
  const ex=$("#genExam").value, topic=($("#genTopic").value||'General').trim(), diff=$("#genDiff").value, count=Math.max(1,Math.min(20,+$("#genCount").value||5));
  const status=$("#genStatus"); if(!base||!model||!key){status.textContent='Fill Base/Model/Key.';return;}
  try{
    status.textContent='Generating…';
    const examName=BANK[ex].name; const items=await callOpenAI(base,model,key,examName,topic,count,diff);
    if(!Array.isArray(items)||!items.length){status.textContent='No items returned.';return;}
    if(!USER_BANK[ex]) USER_BANK[ex]={name:BANK[ex]?.name||ex,topics:[],questions:[]};
    const tset=new Set(USER_BANK[ex].topics||[]); tset.add(topic); USER_BANK[ex].topics=[...tset];
    items.forEach(it=>{
      const id=`${ex}-gen-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`;
      USER_BANK[ex].questions.push({id,type:"single",topic,q:it.question,options:it.options.slice(0,4),answer:it.answerIndex,explain:it.explanation||"—"});
    });
    saveUserBank(USER_BANK); BANK=mergeBanks(); renderExamSelect(); renderTopics();
    status.textContent=`Added ${items.length} questions to ${BANK[ex].name} / ${topic}.`;
  }catch(e){ status.textContent='Generation failed: '+e.message; }
}

/* ---------------- Events ---------------- */
$("#examSelect").addEventListener('change',e=>{STATE.exam=e.target.value;STATE.topicFilters=new Set();STATE.reviewMode=false;renderTopics();renderStats();$("#sessionLabel").textContent=BANK[STATE.exam].name;});
$("#topics").addEventListener('change',e=>{ if(e.target.matches('input[data-topic]')){const t=e.target.getAttribute('data-topic'); e.target.checked?STATE.topicFilters.add(t):STATE.topicFilters.delete(t);} });

$("#startBtn").addEventListener('click',()=>{ if(STATE.mock.active){bubble("<i>Mock running. End it first.</i>");return;} const q=pickQuestion(); if(!q){bubble("<i>No questions available.</i>");return;} renderQuestion(q); });
$("#nextBtn").addEventListener('click',()=>{ if(STATE.mock.active){ if(STATE.mock.index<STATE.mock.queue.length){ renderQuestion(STATE.mock.queue[STATE.mock.index++]); updateMockStatus(); } else { endMock(); } return;} const q=pickQuestion(); if(q) renderQuestion(q);});
$("#skipBtn").addEventListener('click',()=>$("#nextBtn").click());
$("#reviewBtn").addEventListener('click',()=>{ if(STATE.mock.active){bubble("<i>Cannot switch during mock.</i>");return;} STATE.reviewMode=!STATE.reviewMode; $("#modePill").textContent=STATE.reviewMode?"Review Mistakes":"Practice Mode"; });
$("#resetBtn").addEventListener('click',()=>{ if(confirm('Reset progress for this exam?')){ PROG[STATE.exam]={answered:0,correct:0,byTopic:{},mistakes:[]}; saveProg(); renderStats(); bubble("<b>Progress reset.</b>"); } });

$("#startMockBtn").addEventListener('click',startMock);
$("#endMockBtn").addEventListener('click',endMock);
$("#addQBtn").addEventListener('click',addQuestion);
$("#importBankBtn").addEventListener('click',()=>$("#importBankFile").click());
$("#importBankFile").addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{ try{ const data=JSON.parse(r.result); USER_BANK=data; saveUserBank(USER_BANK); BANK=mergeBanks(); renderExamSelect(); renderTopics(); bubble("<b>Bank imported.</b>"); }catch{ alert("Invalid JSON"); } };
  r.readAsText(f);
});
$("#exportBankBtn").addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(USER_BANK,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='custom_question_bank.json'; a.click(); URL.revokeObjectURL(url);
});
$("#genBtn").addEventListener('click',generateAndAdd);

/* Single-choice clicks */
chatEl.addEventListener('click',e=>{
  const btn=e.target.closest('.opt'); if(!btn) return;
  const q=STATE.lastQuestion; if(!q || q.type!=='single') return;
  const idx=+btn.getAttribute('data-idx'); bubble(`<b>My answer:</b> ${String.fromCharCode(65+idx)} — ${q.options[idx]}`,true);
  gradeSingle(q,idx);
});
/* Multi-select submit */
chatEl.addEventListener('click',e=>{
  if(!e.target.closest('#submitMulti')) return;
  const q=STATE.lastQuestion; if(!q || q.type!=='multi') return;
  gradeMulti(q);
});

/* ---------------- Init ---------------- */
function init(){
  renderExamSelect(); renderTopics(); renderStats();
  bubble("<b>Welcome!</b> Choose an exam/part, optionally tick topics, then click <b>Start / Next Question</b>. This build supports <i>single</i> and <i>multi-select</i> questions and includes scenario blocks.");
}
init();
</script>
</body>
</html>
